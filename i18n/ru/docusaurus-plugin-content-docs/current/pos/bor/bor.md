---
id: bor
title: Архитектура Bor
description: Роль Bor в архитектуре Polygon
keywords:
  - docs
  - matic
  - Bor Architecture
  - polygon
image: https://matic.network/banners/matic-network-16x9.png
---
import useBaseUrl from '@docusaurus/useBaseUrl';

# Архитектура Bor {#bor-architecture}

Polygon — это гибридная платформа **Plasma + Proof-of-Stake (PoS)**. Мы используем архитектуру двойного консенсуса в сети Polygon для обеспечения оптимальной скорости и децентрализации. Мы сознательно разработали архитектуру системы таким образом, чтобы обеспечить поддержку произвольных переходов состояний в наших сайдчейнах с поддержкой EVM.

## Архитектура {#architecture}

<img src={useBaseUrl("img/Bor/matic_structure.png")}/>

Блокчейн представляет собой набор сетевых клиентов, взаимодействующих и работающих вместе. Клиент — это программа, способная устанавливать канал связи P2P с другими клиентами, подписывать и транслировать транзакции, развертывать и взаимодействовать со смарт-контрактами и т.д. Клиент часто называют нодом.

Для Polygon узел разработан с двумя слоями реализации Heimdall (Validator Layer) и Bor(Block Producer Layer).

1. Heimdall
    - Проверка доказательства доли владения
    - Чекпойнтинг блоков в Ethereum Mainchain
    - Управление валидаторами и наградами
    - Обеспечение синхронизации с Ethereum Mainchain
    - Децентрализованный мост
2. Bor
    - Polygon Chain
    - VM, совместимая с EVM
    - Выбор набора авторов предложений и блок продюсеров
    - SystemCall
    - Модель комиссии

## Heimdall {#heimdall-validator-layer}

Heimdall (All-Protector) — это поставщик всего, что происходит в системе Polygon Proof-of-Stake, — хороший или плохо.

Heimdall — это наш уровень верификатора PoS, который отвечает за чекпойнтинг представленности блоков Plasma в mainchain нашей архитектуры. Мы реализовали это решение путем надстройки в механизме консенсуса Tendermint с внесением изменений в схему подписи и различные структуры данных.

Подробнее см. [https://blog.matic.network/heimdall-and-bor-matic-validator-and-block-production-layers/](https://blog.matic.network/heimdall-and-bor-matic-validator-and-block-production-layers/).

## Bor (уровень блок продюсеров) {#bor-block-producer-layer}

Реализация нода Bor по сути является оператором сайдчейна. VM сайдчейна совместима с EVM. В настоящее время это базовая реализация Geth с пользовательскими изменениями, внесенными в алгоритм консенсуса. Но решение будет построено с нуля, чтобы сделать его легким и сфокусированным.

Bor — это наш уровень блок продюсеров, который в синхронизации с Heimdall выбирает блок продюсеров и верификаторов для каждого диапазона и спринта. Взаимодействие пользователей Polygon происходит этом сайдчейне, совместимом с EVM, с тем чтобы они имели возможность использовать функциональность и совместимость инструментальных средств и приложений для разработчиков Ethereum.

### Polygon Chain {#polygon-chain}

Эта цепочка представляет собой отдельный блокчейн, который привязан к Ethereum с помощью двухсторонней привязки. Двусторонняя привязка обеспечивает взаимозаменяемость активов между Ethereum и Polygon.

### VM, совместимая с EVM {#evm-compatible-vm}

Виртуальная машина Ethereum (EVM) представляет собой мощный, изолированный виртуальный стек, встроенный в каждый полный нод Polygon и отвечающий за выполнение контрактного байткода. Контракты обычно записываются на языках более высокого уровня, таких как Solidity, а затем компилируются в байткод EVM.

### Выбор авторов предложений и блок продюсеров {#proposers-and-producers-selection}

Блок продюсеры для уровня Bor — это комитет, выбираемый из пула валидаторов на основе их стейка через регулярные промежутки времени, который периодически перетасовывается. Эти промежутки времени определяются управлением валидатора в отношении династии и сети.

Вероятность стать членом комитета блок продюсеров определяется долей/весом стейка.

<img src={useBaseUrl("img/Bor/bor-span.png")} />

#### Процесс отбора {#selection-process}

- Предположим, что в нашем пуле есть 3 валидатора: Alice, Bill и Clara.
- Alice добавила в стейкинг 100 токенов Matic, а Bill и Clara — 40 токенов Matic.
- Валидаторам предоставляются слоты в зависимости от стейка. Поскольку Alice добавила в стейкинг 100 токенов Matic, она получит пропорциональное число слотов. Alice получит в общей сложности 5 слотов. Аналогичным образом Bill и Clara получат в общей сложности по 2 слота.
- Эти слоты предоставляются всем валидаторам [A, A, A, A, A, B, B, C, C]
- Используя прошлые данные по блоку Ethereum в качестве начального значения, мы перемешиваем этот массив.
- Допустим, после перетасовки слотов с использованием начального значения, мы получаем этот массив [A, B, A, A, C, B, A, A, C]
- Теперь в зависимости от общего числа блок продюсеров* (поддерживаемого управлением валидатора*) мы берем первых валидаторов из списка. Например, если мы хотим выбрать 5 блок продюсеров, набор блок продюсеров будет таким: [A, B, A, A, C]
- Следовательно, набор продюсеров для следующего диапазона блоков определяется как [A: 3, B:1, C:1].
- Используя этот набор валидаторов и алгоритм выбора авторов предложений Tendermint, мы выбираем продюсера для каждого спринта на уровне Bor.

### Интерфейс SystemCall {#systemcall-interface}

Системный вызов — это внутренний адрес оператора в рамках EVM. Это помогает поддерживать состояние блок продюсеров для каждого спринта. Системный вызов запускается в конце спринта, и делается запрос на новый список блок продюсеров. Как только состояние обновляется, все валидаторы получают информацию об изменениях после создания блока на Bor.

### функции {#functions}

#### proposeState {#proposestate}

- Вызов разрешен только валидаторам.
- Проверить `stateId`, чтобы определить, не был ли блок предложен или зафиксирован ранее.
- Предложить `stateId` и изменить флажок на `true`.

#### commitState {#commitstate}

- Вызов разрешен только системе.
- Проверить `stateId`, чтобы определить, не был ли блок предложен или зафиксирован ранее.
- Уведомить контракт `StateReceiver` о новом `stateId`.
- Изменить флажок `state` на `true` и `remove` `proposedState`.

#### proposeSpan {#proposespan}

- Вызов разрешен только валидаторам.
- Проверить, является ли статус предложения по диапазону `pending`.
- Обновить статус предложения по диапазону на `true`

#### proposeCommit {#proposecommit}

- Вызов разрешен только системе.
- Назначить `initial validators`, если текущий диапазон равен нулю.
- Проверить условия для `spanId` и `time_period` спринта и диапазона.
- Обновить новые `span` и `time_period`.
- Назначить `validators` и `blockProducers` для `sprint`.
- Изменить флажок для `spanProposal` на `true`.

### Модель комиссии Bor {#bor-fee-model}

В случае обычных транзакций комиссия в токенах Matic собирается и распределяется между блок продюсерами аналогично транзакциям в Ethereum.

Как и другие блокчейны, Polygon имеет нативный токен под названием Matic (MATIC). MATIC — это токен ERC20, используемый преимущественно для оплаты газа (комиссии за транзакции) на Polygon и стейкинга.

:::info

Важно отметить, что в Polygon chain токен MATIC функционирует как токен ERC20, но также одновременно как нативный токен. Следовательно, это означает, что пользователи могут использовать MATIC для оплаты газа, а также отправлять MATIC на другие счета.

:::

Для контрактов genesis, `gasPrice`и `gasLimit`работает так же, как Ethereum, но во время исполнения он не будет вычесть комиссии со счета отправителя.

Транзакции Genesis текущих валидаторов выполняются при условии `gasPrice = 0`.

Кроме того, валидаторы должны отправить следующие типы транзакции, такие как предложения State, такие как предложения State, такие как депозиты и Span в Bor.

## Технические данные {#technical-insight}

### Контракты Genesis {#genesis-contracts}

[BorValidatorSet(0x1000)](https://github.com/maticnetwork/genesis-contracts/blob/master/contracts/BorValidatorSet.template) ⇒ Этот контракт управляет набором валидаторов для каждого диапазона и спринта.

[BorStateReceiver(0x1001)](https://github.com/maticnetwork/genesis-contracts/blob/master/contracts/StateReceiver.sol) ⇒ Этот контракт управляет передачей произвольных контрактных данных из контрактов Ethereum в контракты Polygon.

MaticChildERC20(0x1010) ⇒ Дочерний контракт для токенов Mainchain, который позволяет перемещать активы из Ethereum в Polygon.

### [Bor.go](https://github.com/maticnetwork/bor/blob/master/consensus/bor/bor.go)

Протокол Bor

## Глоссарий {#glossary}

- StartEpoch — номер checkpoint, после которого валидатор активируется и участвует в процессе консенсуса.
- EndEpoch — номер checkpoint, после которого валидатор считается деактивированным и не участвует в процессе консенсуса.
- Спринт — непрерывный набор блоков, созданных одним валидатором.
- Диапазон — большой набор блоков с фиксированным набором валидаторов, но состоящий из различных спринтов. Например, диапазон длиной в 6400 блоков будет состоять из 100 спринтов по 64 блока.
- Династия — время между окончанием последнего аукциона и началом следующего.

## Информационные ресурсы {#resources}

- [Bor](https://github.com/maticnetwork/bor)
- [EVM](https://www.bitrates.com/guides/ethereum/what-is-the-unstoppable-world-computer)
- [Как работает EVM?](https://medium.com/mycrypto/the-ethereum-virtual-machine-how-does-it-work-9abac2b7c9e)
- [Выбор Proposer Tendermint](https://docs.tendermint.com/master/spec/reactors/consensus/proposer-selection.html)
