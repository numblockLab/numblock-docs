---
id: set-up-ibft-on-the-cloud
title: Облачная настройка
description: "Пошаговое руководство по облачной настройке."
keywords:
  - docs
  - polygon
  - edge
  - cloud
  - setup
  - genesis
---

:::info Данное руководство описывает настройку основной сети mainnet или тестовой сети testnet

Руководство, приведенное ниже, предоставит вам инструкции о том, как настроить сеть Polygon Edge на облачном провайдере для работы вашей тестовой сети testnet или основной сети mainnet.

Если вы хотите установить сеть Polygon Edge локально для быстрой проверки `polygon-edge` перед тем, как осуществить установку для производства, обратитесь к разделу **[Локальная настройка](/docs/edge/get-started/set-up-ibft-locally)**
:::

## Требования {#requirements}

В разделе [Установка](/docs/edge/get-started/installation) описывается установка Polygon Edge.

### Настройка подключения VM (виртуальных машин) {#setting-up-the-vm-connectivity}

В зависимости от выбора облачного провайдера вы можете настроить подключение и правила между VM (виртуальными машинами) с помощью брандмауэра, групп безопасности или списков контроля доступа.

Поскольку единственной частью `polygon-edge`, которая должна быть открыта для других VM, является сервер libp2p, достаточно просто разрешить все коммуникации между VM через порт libp2p `1478` по умолчанию.

## Обзор {#overview}

![Облачная настройка](/img/edge/ibft-setup/cloud.svg)

Цель этого руководства — развернуть рабочую `polygon-edge` сеть блокчейна, использующую [протокол консенсуса IBFT](https://github.com/ethereum/EIPs/issues/650).
Сеть блокчейна будет состоять из 4 нодов, все из которых будут являться валидаторами и соответственно будут иметь полномочия предлагать блоки и подтверждать блоки, поступившие от других авторов предложений.
Каждый из 4 нодов будет работать на своей собственной VM, поскольку идея данного руководства заключается в том, чтобы предоставить вам полностью функциональную сеть Polygon Edge, сохраняя ключи валидатора в тайне, чтобы обеспечить надежную настройку сети.

Для этого мы выполним 4 простых шага:

0. Ознакомьтесь со списком **требований**, который приведен выше
1. Сгенерируйте приватный ключ для каждого из валидаторов и инициализируйте директорию данных
2. Подготовьте строку подключения для загрузочного нода, который будет помещен в общий `genesis.json`
3. Создайте `genesis.json` на своей локальной машине и отправьте/переведите его на каждый из нодов
4. Запустите все ноды

:::info Количество валидаторов

Минимального ограничения количества нодов в кластере нет, т. е. можно создавать кластеры только с одним нодом валидатора.
Необходимо помнить, что кластер с _единственным_ нодом не имеет **отказоустойчивости** и **гарантии BFT**.

Для достижения гарантии BFT рекомендуется использовать кластер, содержащий не менее 4 нодов, потому что такой кластер выдерживает выход из строя 1 нода при нормальной работе остальных 3 нодов.

:::

## Шаг 1: инициализируйте папки данных и сгенерируйте ключи валидатора {#step-1-initialize-data-folders-and-generate-validator-keys}

Чтобы начать работу с Polygon Edge, необходимо инициализировать папки данных на каждом ноде:


````bash
node-1> polygon-edge secrets init --data-dir data-dir
````

````bash
node-2> polygon-edge secrets init --data-dir data-dir
````

````bash
node-3> polygon-edge secrets init --data-dir data-dir
````

````bash
node-4> polygon-edge secrets init --data-dir data-dir
````

Каждая из этих команд выводит на печать ключ валидатора, публичный ключ BLS и [идентификатор нода](https://docs.libp2p.io/concepts/peer-id/). Для следующего шага вам потребуется идентификатор первого нода.

### Секреты {#outputting-secrets}
Вывод секретов может быть возвращен снова, если это необходимо.

```bash
polygon-edge secrets output --data-dir test-chain-4
```

:::warning Держите свою директорию данных в секрете!

Созданные выше директории данных, помимо инициализации директорий для хранения состояния блокчейна, также будут генерировать приватный ключ вашего валидатора. **Этот ключ должен храниться в секрете, поскольку его кража приведет к тому, что кто-то сможет выдать вас за валидатора в сети!**
:::

## Шаг 2: подготовьте мультиадресную строку подключения для загрузочного нода {#step-2-prepare-the-multiaddr-connection-string-for-the-bootnode}

Для успешного подключения нода необходимо знать, к какому серверу `bootnode` этот нод должен подключиться для получения информации обо всех остальных нодах в сети. На жаргоне p2p `bootnode` иногда также называют сервером `rendezvous`.

`bootnode`не является особенным экземпляром нода Polygon Edge. Каждый нод Polygon Edge может работать в качестве `bootnode`, и каждый нод Polygon Edge должен иметь набор загрузочных нодов, к которым будут обращаться для получения информации о том, как подключиться ко всем остальным нодам в сети.

Чтобы создать строку подключения для указания загрузочного нода, необходимо соблюдать мультиадресный формат [multiaddr](https://docs.libp2p.io/concepts/addressing/):
```
/ip4/<ip_address>/tcp/<port>/p2p/<node_id>
```

В этом руководстве мы будем рассматривать первый и второй ноды как загрузочные ноды для всех остальных нодов. В этом сценарии ноды, подключающиеся к `node 1` или `node 2`, получат информацию о подключении друг к другу через общий загрузочный нод, с которым они контактируют.

:::info Для запуска нода необходимо указать хотя бы один загрузочный нод

Чтобы ноды в сети могли находить друг друга, требуется хотя бы **один** загрузочный нод. Рекомендуется использовать больше загрузочных нодов, поскольку они обеспечивают устойчивость сети в случае неполадок.
В этом руководстве мы укажем два нода, но это можно изменить в любое время, что не повлияет на действительность файла `genesis.json`.

:::

Поскольку первая часть строки получения multiaddr — это `<ip_address>`, сюда вам нужно ввести IP-адрес, который могут достичь другие ноды, в зависимости от вашей настройки, это может быть приватный или публичный IP-адрес, а не `127.0.0.1`.

Для `<port>` мы будем использовать `1478`, поскольку это является портом libp2p по умолчанию.

Наконец, нам потребуется `<node_id>`, который мы получим из вывода ранее выполненной команды `polygon-edge secrets init --data-dir data-dir` (которая использовалась для генерирования ключей и каталогов данных для `node 1`)

После сборки строка подключения multiaddr для нода `node 1`, который мы будем использовать как загрузочный нод, будет выглядеть примерно так (отличаться будет только `<node_id>` в конце):
```
/ip4/<public_or_private_ip>/tcp/1478/p2p/16Uiu2HAmJxxH1tScDX2rLGSU9exnuvZKNM9SoK3v315azp68DLPW
```
Точно так же мы построим мультиадресную строку multiaddr для второго загрузочного нода, как показано ниже
```
/ip4/<public_or_private_ip>/tcp/1478/p2p/16Uiu2HAmS9Nq4QAaEiogE4ieJFUYsoH28magT7wSvJPpfUGBj3Hq
```
:::info Имена хостов DNS вместо IP-адресов

Polygon Edge поддерживает использование имен хостов DNS для конфигурации нодов. Это очень полезная функция при облачном развертывании, поскольку IP-адрес нода может измениться в связи с различными причинами.

Мультиадресный формат строки подключения multiaddr с использованием имен хостов DNS выглядит следующим образом:
`/dns4/sample.hostname.com/tcp/<port>/p2p/nodeid`

:::

## Шаг 3: сгенерируйте файл генезиса с 4 нодами в качестве валидаторов {#step-3-generate-the-genesis-file-with-the-4-nodes-as-validators}

Этот шаг может быть осуществлен на вашей локальной машине, но вам понадобятся публичные ключи валидатора для каждого из 4 валидаторов.

Валидаторы могут безопасно разделить `Public key (address)`, как показано ниже в выводе на их команды `secrets init`, чтобы вы могли безопасно сгенерировать genesis.json с теми валидаторами в первоначальном наборе, которые идентифицированы их публичным ключами:

```
[SECRETS INIT]
Public key (address) = 0xC12bB5d97A35c6919aC77C709d55F6aa60436900
BLS Public key       = 0x9952735ca14734955e114a62e4c26a90bce42b4627a393418372968fa36e73a0ef8db68bba11ea967ff883e429b3bfdf
Node ID              = 16Uiu2HAmVZnsqvTwuzC9Jd4iycpdnHdyVZJZTpVC8QuRSKmZdUrf
```

Учитывая, что вы получили все 4 публичных ключа валидатора, вы сможете запустить следующую команду, чтобы сгенерировать `genesis.json`

````bash
polygon-edge genesis --consensus ibft --ibft-validator 0xC12bB5d97A35c6919aC77C709d55F6aa60436900:0x9952735ca14734955e114a62e4c26a90bce42b4627a393418372968fa36e73a0ef8db68bba11ea967ff883e429b3bfdf --ibft-validator <2nd validator IBFT public key>:<2nd validator BLS public key> --ibft-validator <3rd validator IBFT public key>:<3rd validator BLS public key> --ibft-validator <4th validator IBFT public key>:<4th validator BLS public key> --bootnode=<first_bootnode_multiaddr_connection_string_from_step_2> --bootnode <second_bootnode_multiaddr_connection_string_from_step_2> --bootnode <optionally_more_bootnodes>
````

Что делает эта команда:

* `--ibft-validator` устанавливает публичный ключ валидатора, который должен быть включен в первоначальный набор валидаторов в генезисном блоке. Первоначальных валидаторов может быть много.
* `--bootnode` устанавливает адрес загрузочного нода, который позволит нодам находить друг друга.
Мы будем использовать строку multiaddr `node 1`, как упоминается в **шаге 2**, также вы можете добавить столько загрузочных нодов, сколько захотите, как показано выше.

:::info Переключить в ECDSA

BLS — это режим валидации заголовков блока по умолчанию. Если вы хотите, чтобы ваша цепочка работала в режиме ECDSA, вы можете использовать `—ibft-validator-type`флаг , с `ecdsa`аргументом:

```
genesis --ibft-validator-type ecdsa
```
:::

:::info Предварительное пополнение аккаунта

Возможно, вы захотите настроить свою сеть блокчейна так, чтобы на некоторых адресах был предварительно пополнен баланс.

Для этого можно передать любое количество параметров `--premine` на каждый адрес, который вы захотите инициализировать с определенным балансом
в блокчейне.

Например, если вы захотите предварительно загрузить 1000 ETH на адрес `0x3956E90e632AEbBF34DEB49b71c28A83Bc029862` в нашем блоке генезиса, нам нужно будет предоставить следующий аргумент:

```
--premine=0x3956E90e632AEbBF34DEB49b71c28A83Bc029862:1000000000000000000000
```

**Обратите внимание, что предварительно загружаемая сумма указывается в WEI, а не ETH.**

:::

:::info Установите лимит газа для блока

По умолчанию для каждого блока установлен лимит газа `5242880`. Это значение записывается в файл генезиса, но, возможно, вы захотите
увеличить или уменьшить его.

Для этого вы можете использовать параметр `--block-gas-limit` с желаемым значением, как показано ниже :

```shell
--block-gas-limit 1000000000
```

:::

:::info Установка лимита дескрипторов системного файла

Некоторые операционные системы имеют невысокий лимит дескрипторов файла по умолчанию (максимальное количество открытых файлов).
Если ожидается, что для нодов потребуется высокая пропускная способность, вы можете попробовать увеличить этот лимит на уровне ОС.

Для дистрибутива Ubuntu процедура будет выглядеть следующим образом (если вы не используете дистрибутив Ubuntu/Debian, воспользуйтесь официальной документацией для вашей ОС) :
- Проверьте текущие лимиты ОС (по количеству открытых файлов)
```shell title="ulimit -a"
ubuntu@ubuntu:~$ ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 15391
max locked memory       (kbytes, -l) 65536
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 15391
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
```

- Увеличьте лимит открытых файлов
	- Локально — влияет только на текущую сессию:
	```shell
	ulimit -u 65535
	```
	- Глобально или на пользователя (лимиты добавляются в конец файла /etc/security/limits.conf) :
	```shell
	sudo vi /etc/security/limits.conf  # we use vi, but you can use your favorite text editor
	```
	```shell title="/etc/security/limits.conf"
	# /etc/security/limits.conf
	#
	#Each line describes a limit for a user in the form:
	#
	#<domain>        <type>  <item>  <value>
	#
	#Where:
	#<domain> can be:
	#        - a user name
	#        - a group name, with @group syntax
	#        - the wildcard *, for default entry
	#        - the wildcard %, can be also used with %group syntax,
	#                 for maxlogin limit
	#        - NOTE: group and wildcard limits are not applied to root.
	#          To apply a limit to the root user, <domain> must be
	#          the literal username root.
	#
	#<type> can have the two values:
	#        - "soft" for enforcing the soft limits
	#        - "hard" for enforcing hard limits
	#
	#<item> can be one of the following:
	#        - core - limits the core file size (KB)
	#        - data - max data size (KB)
	#        - fsize - maximum filesize (KB)
	#        - memlock - max locked-in-memory address space (KB)
	#        - nofile - max number of open file descriptors
	#        - rss - max resident set size (KB)
	#        - stack - max stack size (KB)
	#        - cpu - max CPU time (MIN)
	#        - nproc - max number of processes
	#        - as - address space limit (KB)
	#        - maxlogins - max number of logins for this user

	#        - maxsyslogins - max number of logins on the system
	#        - priority - the priority to run user process with
	#        - locks - max number of file locks the user can hold
	#        - sigpending - max number of pending signals
	#        - msgqueue - max memory used by POSIX message queues (bytes)
	#        - nice - max nice priority allowed to raise to values: [-20, 19]
	#        - rtprio - max realtime priority
	#        - chroot - change root to directory (Debian-specific)
	#
	#<domain>      <type>  <item>         <value>
	#

	#*               soft    core            0
	#root            hard    core            100000
	#*               hard    rss             10000
	#@student        hard    nproc           20
	#@faculty        soft    nproc           20
	#@faculty        hard    nproc           50
	#ftp             hard    nproc           0
	#ftp             -       chroot          /ftp
	#@student        -       maxlogins       4

	*               soft    nofile          65535
	*               hard    nofile          65535

	# End of file
	```
Также вы можете изменить дополнительные параметры, сохранить файл и перезапустить систему.
После перезапуска проверьте лимит дескриптора файлов еще раз.
Для него необходимо будет установить значение, которое вы определили в файле limits.conf.

:::

После уточнения следующих параметров:
1. Публичные ключи валидатора, которые включены в генезисный блок в качестве набора валидаторов
2. Строки подключения загрузочного нода multiaddr
3. Предварительно созданные аккаунты и балансы, которые включены в генезесный блок

и генерируя `genesis.json`, вы должны скопировать его во все VM в сети. В зависимости от вашей настройки вы можете скопировать/вставить его, отправить его оператору нода или просто передать по SCP/FTP.

Структура файла генезиса описана в разделе [Команды интерфейса командной строки (CLI)](/docs/edge/get-started/cli-commands).

## Шаг 4: запустите все клиенты {#step-4-run-all-the-clients}

:::note Сетевое взаимодействие с облачными провайдерами

Большинство облачных провайдеров не раскрывают IP-адреса (особенно если они публичные) в качестве прямого сетевого интерфейса на вашей виртуальной машине (VM), а устанавливают невидимый прокси-сервер NAT.


Чтобы позволить нодам подключиться друг к другу в этом случае, вам необходимо прослушать IP-адрес `0.0.0.0` для связывания на всех интерфейсах, но вам все равно потребуется указать IP-адрес или DNS-адрес, который другие ноды могут использовать для подключения к вашему экземпляру. Это достигается с помощью аргумента `--nat` или `--dns`, где вы можете указать внешний адрес IP или DNS соответственно.

#### Пример {#example}

Связанный IP-адрес, который вы хотите прослушать, — это `192.0.2.1`, но он не связан напрямую ни с одним из интерфейсов вашей сети.

Чтобы разрешить нодам соединяться друг с другом, вы должны передать следующие параметры:

`polygon-edge ... --libp2p 0.0.0.0:10001 --nat 192.0.2.1`

Или, если вы хотите указать DNS-адрес `dns/example.io`, передайте следующие параметры:

`polygon-edge ... --libp2p 0.0.0.0:10001 --dns dns/example.io`

Это заставит ваш нод прослушать все интерфейсы, но также даст ему понять, что клиенты подключаются к нему через указанный адрес `--nat`или `--dns`.

:::

Запустите **первый** клиент:


````bash
node-1> polygon-edge server --data-dir ./data-dir --chain genesis.json  --libp2p 0.0.0.0:1478 --nat <public_or_private_ip> --seal
````

Запустите **второй** клиент:

````bash
node-2> polygon-edge server --data-dir ./data-dir --chain genesis.json --libp2p 0.0.0.0:1478 --nat <public_or_private_ip> --seal
````

Запустите **третий** клиент:

````bash
node-3> polygon-edge server --data-dir ./data-dir --chain genesis.json --libp2p 0.0.0.0:1478 --nat <public_or_private_ip> --seal
````

Запустите **четвертый** клиент:

````bash
node-4> polygon-edge server --data-dir ./data-dir --chain genesis.json --libp2p 0.0.0.0:1478 --nat <public_or_private_ip> --seal
````

Запустив предыдущие команды, вы настроили сеть Polygon Edge из 4 нодов, которая способна запечатывать блоки и восстанавливаться после выхода нода из строя.

:::info Запустите клиент, используя файл конфигурации

Вместо того чтобы указывать все параметры конфигурации как аргументы CLI, клиент также  можно запустить с использованием файла конфигурации, выполнив следующую команду:

````bash
polygon-edge server --config <config_file_path>
````
Пример:

````bash
polygon-edge server --config ./test/config-node1.json
````
В настоящее время мы `json`поддерживаем только файл конфигурации, файл конфигурации можно найти **[здесь](/docs/edge/configuration/sample-config)**

:::

:::info Шаги для запуска нода, который не является валидатором

Нод, не являющийся валидатором, всегда будет синхронизировать последние блоки, получаемые от нода валидатора. Для запуска нода, не являющегося валидатором, служит следующая команда.

````bash
polygon-edge server --data-dir <directory_path> --chain <genesis_filename>  --libp2p <IPAddress:PortNo> --nat <public_or_private_ip>
````
Например, вы можете добавить **пятый** клиент, не являющийся валидатором, выполнив следующую команду :

````bash
polygon-edge server --data-dir ./data-dir --chain genesis.json --libp2p 0.0.0.0:1478 --nat<public_or_private_ip>
````
:::

:::info Укажите лимит цены

Нод Polygon Edge можно запустить с заданным **лимитом цены** для входящих транзакций.

Единица измерения лимита цены: `wei`.

Установка лимита цены означает, что любые транзакции, обработанные текущим нодом, должны иметь цену на газ **выше**,
чем цена заданного лимита, в противном случае он не будет включен в блок.

Если для большинства нодов установлен определенный лимит цены, вводится правило, что транзакции в сети
не могут опускаться ниже определенного порога цены.

По умолчанию лимит цены имеет значение `0`, т. е. он не применяется принудительно.

Пример использования параметра `--price-limit`:
````bash
polygon-edge server --price-limit 100000 ...
````

Следует отметить, что лимиты цены **принудительно устанавливаются только для транзакций, не являющихся локальными**, т. е.
лимит цены не относится к транзакциям, которые добавляются на нод локально.
:::

:::info URL-адрес WebSocket
По умолчанию при запуске Polygon Edge генерируется WebSocket URL на базе расположения цепочки.
Схема URL `wss://` используется для ссылок HTTPS, а `ws://` — для HTTP.

URL-адрес Localhost WebSocket:
````bash
ws://localhost:10002/ws
````
Обратите внимание, что номер порта зависит от выбранного для нода порта JSON-RPC.

URL-адрес Edgenet WebSocket:
````bash
wss://rpc-edgenet.polygon.technology/ws
````
:::
