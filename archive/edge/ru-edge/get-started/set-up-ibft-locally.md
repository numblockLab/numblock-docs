---
id: set-up-ibft-locally
title: Локальная настройка
description: "Пошаговое руководство по локальной настройке."
keywords:
  - docs
  - polygon
  - edge
  - local
  - setup
  - genesis
---

:::caution Настоящее руководство предназначено исключительно для целей тестирования

Данное руководство содержит инструкции по настройке сети Polygon Edge на локальном компьютере для целей тестирования и разработки .

Данная процедура сильно отличается от процедуры настройки сети Polygon Edge в реальном сценарии на системе Облачный провайдер: **[Cloud Setup](/docs/edge/get-started/set-up-ibft-on-the-cloud)**

:::


## Требования {#requirements}

В разделе [Установка](/docs/edge/get-started/installation) описывается установка Polygon Edge.

## Обзор {#overview}

![Локальная настройка](/img/edge/ibft-setup/local.svg)

Цель этого руководства — развернуть рабочую `polygon-edge` сеть блокчейна, использующую [протокол консенсуса IBFT](https://github.com/ethereum/EIPs/issues/650).
Сеть блокчейна будет состоять из 4 нодов, все из которых будут являться валидаторами и соответственно будут иметь полномочия предлагать блоки и подтвердждать блоки, поступившие от других авторов предложений.
Все 4 нода будут работать на одном компьютере, поскольку настоящее руководство призвано помочь вам развернуть полностью функциональный кластер IBFT за минимальное время.

Для этого мы выполним 4 простых шага.

1. При инициализации каталогов данных будут сгенерированы ключи валидатора для каждого из 4 нодов и будут инициализированы пустые каталоги данных блокчейна. Ключи валидатора играют важную роль, поскольку с их помощью мы добавим в загрузку блок генезиса с начальным набором валидаторов.
2. Подготовка строки подключения для загрузочного нода даст необходимую информацию для каждого нода, который мы будем запускать, в том числе о том, к какому ноду подключаться при первом запуске.
3. При генерировании файла `genesis.json` в качестве исходных данных потребуются ключи валидатора, сгенерированные на **шаге 1**, для настройки начальных валидаторов сети в блоке генезиса и строка подключения загрузочного нода из **шага 2**.
4. Последним шагом и главной целью этого руководства будет запуск всех нодов. При этом мы сообщим нодам, какую директорию данных им нужно будет использовать и где найти `genesis.json` для полной загрузки начального состояния сети.

Поскольку все четыре нода будут работать на локальной системе localhost, при настройке предполагается, что все каталоги данных каждого из нодов находятся в одном и том же родительском каталоге.

:::info Количество валидаторов

Минимального ограничения количества нодов в кластере нет, т. е. можно создавать кластеры только с одним нодом валидатора.
Необходимо помнить, что кластер с _единственным_ нодом не имеет **отказоустойчивости** и **гарантии BFT**.

Для достижения гарантии BFT рекомендуется использовать кластер, содержащий не менее 4 нодов, потому что такой кластер выдерживает выход из строя 1 нода при нормальной работе остальных 3 нодов.

:::

## Шаг 1: инициализация папок данных для IBFT и генерирование ключей валидатора {#step-1-initialize-data-folders-for-ibft-and-generate-validator-keys}

Для начала работы с IBFT необходимо инициализировать папки данных,
по одной для каждого нода:

````bash
polygon-edge secrets init --data-dir test-chain-1
````

````bash
polygon-edge secrets init --data-dir test-chain-2
````

````bash
polygon-edge secrets init --data-dir test-chain-3
````

````bash
polygon-edge secrets init --data-dir test-chain-4
````

Каждая из этих команд выводит на печать ключ валидатора, публичный ключ BLS и [идентификатор нода](https://docs.libp2p.io/concepts/peer-id/). Для следующего шага вам потребуется идентификатор первого нода.

### Секреты {#outputting-secrets}
Вывод секретов может быть возвращен снова, если это необходимо.

```bash
polygon-edge secrets output --data-dir test-chain-4
```

## Шаг 2: подготовка мультиадресной строки подключения для загрузочного нода {#step-2-prepare-the-multiaddr-connection-string-for-the-bootnode}

Для успешного подключения нода необходимо знать, к какому серверу `bootnode` этот нод должен подключиться для получения информации обо всех остальных нодах в сети. На жаргоне p2p `bootnode` иногда также называют сервером `rendezvous`.

`bootnode` не является особенным экземпляром нода Polygon Edge. Каждый нод Polygon Edge может выступать в качестве `bootnode`, но
для каждого нода Polygon Edge требуется указать набор загрузочных нодов, у которых будет запрашиваться информация о способе подключения ко всем остальным нодам в сети.

Чтобы создать строку подключения для указания загрузочного нода, необходимо соблюдать мультиадресный формат [multiaddr](https://docs.libp2p.io/concepts/addressing/):
```
/ip4/<ip_address>/tcp/<port>/p2p/<node_id>
```

В этом руководстве мы будем рассматривать первый и второй ноды как загрузочные ноды для всех остальных нодов. В этом сценарии ноды, подключающиеся к `node 1` или `node 2`, получат информацию о подключении друг к другу через общий загрузочный нод, с которым они контактируют.

:::info Для запуска нода необходимо указать хотя бы один загрузочный нод

Чтобы ноды в сети могли находить друг друга, требуется хотя бы **один** загрузочный нод. Рекомендуется использовать больше загрузочных нодов, поскольку они обеспечивают устойчивость сети в случае неполадок.
В этом руководстве мы укажем два нода, но это можно изменить в любое время, что не повлияет на действительность файла `genesis.json`.

:::

Поскольку мы работаем в локальной системе localhost, можно предположить, что `<ip_address>` является `127.0.0.1`.

Для `<port>` мы будем использовать `10001`, поскольку мы собираемся настроить сервер libp2p для `node 1` для последующего прослушивания этого порта.

Наконец, нам потребуется `<node_id>`, который мы получим из вывода ранее выполненной команды `polygon-edge secrets init --data-dir test-chain-1` (которая использовалась для генерирования ключей и каталогов данных для `node1`)

После сборки строка подключения multiaddr для нода `node 1`, который мы будем использовать как загрузочный нод, будет выглядеть примерно так (отличаться будет только `<node_id>` в конце):
```
/ip4/127.0.0.1/tcp/10001/p2p/16Uiu2HAmJxxH1tScDX2rLGSU9exnuvZKNM9SoK3v315azp68DLPW
```
Точно так же мы построим мультиадресную строку multiaddr для второго загрузочного нода, как показано ниже
```
/ip4/127.0.0.1/tcp/20001/p2p/16Uiu2HAmS9Nq4QAaEiogE4ieJFUYsoH28magT7wSvJPpfUGBj3Hq
```

:::info Имена хостов DNS вместо IP-адресов

Polygon Edge поддерживает использование имен хостов DNS для конфигурации нодов. Это очень полезная функция при облачном развертывании, поскольку IP-адрес нода может измениться в связи с различными причинами.

Мультиадресный формат строки подключения multiaddr с использованием имен хостов DNS выглядит следующим образом:
`/dns4/sample.hostname.com/tcp/<port>/p2p/nodeid`

:::


## Шаг 3: генерирование файла генезиса с 4 нодами в качестве валидаторов {#step-3-generate-the-genesis-file-with-the-4-nodes-as-validators}

````bash
polygon-edge genesis --consensus ibft --ibft-validators-prefix-path test-chain- --bootnode /ip4/127.0.0.1/tcp/10001/p2p/16Uiu2HAmJxxH1tScDX2rLGSU9exnuvZKNM9SoK3v315azp68DLPW --bootnode /ip4/127.0.0.1/tcp/20001/p2p/16Uiu2HAmS9Nq4QAaEiogE4ieJFUYsoH28magT7wSvJPpfUGBj3Hq
````

Что делает эта команда:

* `--ibft-validators-prefix-path` устанавливает указанный путь папки префиксов, который может использовать
IBFT в Polygon Edge. Этот каталог используется для размещения папки `consensus/`, в которой хранится приватный ключ валидатора. При этом
публичный ключ валидатора потребуется для создания файла генезиса — первоначального списка загрузочных нодов.
Этот параметр имеет смысл использовать только при настройке сети в локальной системе localhost, поскольку в реальных условиях нельзя ожидать, что все
каталоги данных нодов будут находиться в одной файловой системе, откуда мы сможем легко считать их публичные ключи.
* `--bootnode` устанавливает адрес загрузочного нода, который позволит нодам находить друг друга.
Мы будем использовать строку multiaddr из `node 1`, как описано в **шаге 2**.

В результате выполнения этой команды мы получим файл `genesis.json`, содержащий блок генезиса нашего нового блокчейна с заданным набором валидаторов и конфигурацией, которая покажет, с каким нодом следует связаться в первую очередь для установления подключения.

:::info Переключить в ECDSA

BLS — это режим валидации заголовков блока по умолчанию. Если вы хотите, чтобы ваша цепочка работала в режиме ECDSA, вы можете использовать `—ibft-validator-type`флаг , с `ecdsa`аргументом:

```
genesis --ibft-validator-type ecdsa
```
:::
:::info Предварительное пополнение аккаунта

Возможно, вы захотите настроить свою сеть блокчейна так, чтобы на некоторых адресах был предварительно пополнен баланс.

Для этого можно передать любое количество параметров `--premine` на каждый адрес, который вы захотите инициализировать с определенным балансом
в блокчейне.

Например, если вы захотите предварительно загрузить 1000 ETH на адрес `0x3956E90e632AEbBF34DEB49b71c28A83Bc029862` в нашем блоке генезиса, нам нужно будет предоставить следующий аргумент:

```
--premine=0x3956E90e632AEbBF34DEB49b71c28A83Bc029862:1000000000000000000000
```

**Обратите внимание, что предварительно загружаемая сумма указывается в WEI, а не ETH.**

:::

:::info Установите лимит газа для блока

По умолчанию для каждого блока установлен лимит газа `5242880`. Это значение записывается в файл генезиса, но, возможно, вы захотите
увеличить или уменьшить его.

Для этого вы можете использовать параметр `--block-gas-limit` с желаемым значением, как показано ниже :

```shell
--block-gas-limit 1000000000
```

:::

:::info Установка лимита дескрипторов системного файла

Некоторые операционные системы имеют невысокий лимит дескрипторов файла по умолчанию (максимальное количество открытых файлов).
Если ожидается, что для нодов потребуется высокая пропускная способность, вы можете попробовать увеличить этот лимит на уровне ОС.

Для дистрибутива Ubuntu процедура будет выглядеть следующим образом (если вы не используете дистрибутив Ubuntu/Debian, воспользуйтесь официальной документацией для вашей ОС) :
- Проверьте текущие лимиты ОС (по количеству открытых файлов)
```shell title="ulimit -a"
ubuntu@ubuntu:~$ ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 15391
max locked memory       (kbytes, -l) 65536
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 15391
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
```

- Увеличьте лимит открытых файлов
	- Локально — влияет только на текущую сессию:
	```shell
	ulimit -u 65535
	```
	- Глобально или на пользователя (лимиты добавляются в конец файла /etc/security/limits.conf) :
	```shell
	sudo vi /etc/security/limits.conf  # we use vi, but you can use your favorite text editor
	```
	```shell title="/etc/security/limits.conf"
	# /etc/security/limits.conf
	#
	#Each line describes a limit for a user in the form:
	#
	#<domain>        <type>  <item>  <value>
	#
	#Where:
	#<domain> can be:
	#        - a user name
	#        - a group name, with @group syntax
	#        - the wildcard *, for default entry
	#        - the wildcard %, can be also used with %group syntax,
	#                 for maxlogin limit
	#        - NOTE: group and wildcard limits are not applied to root.
	#          To apply a limit to the root user, <domain> must be
	#          the literal username root.
	#
	#<type> can have the two values:
	#        - "soft" for enforcing the soft limits
	#        - "hard" for enforcing hard limits
	#
	#<item> can be one of the following:
	#        - core - limits the core file size (KB)
	#        - data - max data size (KB)
	#        - fsize - maximum filesize (KB)
	#        - memlock - max locked-in-memory address space (KB)
	#        - nofile - max number of open file descriptors
	#        - rss - max resident set size (KB)
	#        - stack - max stack size (KB)
	#        - cpu - max CPU time (MIN)
	#        - nproc - max number of processes
	#        - as - address space limit (KB)
	#        - maxlogins - max number of logins for this user

	#        - maxsyslogins - max number of logins on the system
	#        - priority - the priority to run user process with
	#        - locks - max number of file locks the user can hold
	#        - sigpending - max number of pending signals
	#        - msgqueue - max memory used by POSIX message queues (bytes)
	#        - nice - max nice priority allowed to raise to values: [-20, 19]
	#        - rtprio - max realtime priority
	#        - chroot - change root to directory (Debian-specific)
	#
	#<domain>      <type>  <item>         <value>
	#

	#*               soft    core            0
	#root            hard    core            100000
	#*               hard    rss             10000
	#@student        hard    nproc           20
	#@faculty        soft    nproc           20
	#@faculty        hard    nproc           50
	#ftp             hard    nproc           0
	#ftp             -       chroot          /ftp
	#@student        -       maxlogins       4

	*               soft    nofile          65535
	*               hard    nofile          65535

	# End of file
	```
Также вы можете изменить дополнительные параметры, сохранить файл и перезапустить систему.
После перезапуска проверьте лимит дескриптора файлов еще раз.
Для него необходимо будет установить значение, которое вы определили в файле limits.conf.

:::


## Шаг 4: запуск всех клиентов {#step-4-run-all-the-clients}

Поскольку мы пытаемся запустить сеть Polygon Edge из 4 нодов на одном компьютере, нам нужно следить за тем, чтобы
избежать конфликтов портов. Поэтому мы выделим порты прослушивания каждого сервера нода на следующих основаниях:

- `10000` для сервера gRPC `node 1`, `20000` для сервера GRPC `node 2` и т. д.
- `10001` для сервера libp2p `node 1`, `20001` для сервера libp2p `node 2` и т. д.
- `10002` для сервера JSON-RPC `node 1`, `20002` для сервера JSON-RPC `node 2` и т. д.

Запустите **первый** клиент (обратите внимание на порт `10001`, потому что он использовался в составе libp2p multiaddr на **шаге  2** вместе с идентификатором нода 1):

````bash
polygon-edge server --data-dir ./test-chain-1 --chain genesis.json --grpc-address :10000 --libp2p :10001 --jsonrpc :10002 --seal
````

Запустите **второй** клиент:

````bash
polygon-edge server --data-dir ./test-chain-2 --chain genesis.json --grpc-address :20000 --libp2p :20001 --jsonrpc :20002 --seal
````

Запустите **третий** клиент:

````bash
polygon-edge server --data-dir ./test-chain-3 --chain genesis.json --grpc-address :30000 --libp2p :30001 --jsonrpc :30002 --seal
````

Запустите **четвертый** клиент:

````bash
polygon-edge server --data-dir ./test-chain-4 --chain genesis.json --grpc-address :40000 --libp2p :40001 --jsonrpc :40002 --seal
````

Краткий обзор уже выполненных задач:

* Указана диретория данных клиента **./test-chain-\***
* Серверы GRPC запущены для каждого нода на портах **10000**, **20000**, **30000** и **40000** соответственно
* Серверы libp2p запущены для каждого нода на портах **10001**, **20001**, **30001** и **40001** соответственно
* Серверы JSON-RPC запущены для каждого нода на портах **10002**, **20002**, **30002** и**40002** соответственно
* Параметр *seal* указывает, что запускаемый нод будет участвовать в запечатывании блока
* Параметр *chain* указывает, какой файл генезиса следует использовать для конфигурации цепочки

Структура файла генезиса описана в разделе [Команды интерфейса командной строки (CLI)](/docs/edge/get-started/cli-commands).

Запустив предыдущие команды, вы настроили сеть Polygon Edge из 4 нодов, которая способна запечатывать блоки и восстанавливаться после выхода нода из строя.

:::info Запустите клиент, используя файл конфигурации

Вместо того чтобы указывать все параметры конфигурации как аргументы CLI, клиент также  можно запустить с использованием файла конфигурации, выполнив следующую команду:

````bash
polygon-edge server --config <config_file_path>
````
Пример:

````bash
polygon-edge server --config ./test/config-node1.json
````
В настоящее время мы поддерживаем `yaml`и `json`основанные файлы конфигурации, файлы конфигурации образца можно найти **[здесь](/docs/edge/configuration/sample-config)**

:::

:::info Шаги для запуска нода, который не является валидатором

Нод, не являющийся валидатором, всегда будет синхронизировать последние блоки, получаемые от нода валидатора. Для запуска нода, не являющегося валидатором, служит следующая команда.

````bash
polygon-edge server --data-dir <directory_path> --chain <genesis_filename> --grpc-address <portNo> --libp2p <portNo> --jsonrpc <portNo>
````
Например, вы можете добавить **пятый** клиент, не являющийся валидатором, выполнив следующую команду :

````bash
polygon-edge server --data-dir ./test-chain --chain genesis.json --grpc-address :50000 --libp2p :50001 --jsonrpc :50002
````
:::

:::info Укажите лимит цены

Нод Polygon Edge можно запустить с заданным **лимитом цены** для входящих транзакций.

Единица измерения лимита цены: `wei`.

Установка лимита цены означает, что любые транзакции, обработанные текущим нодом, должны иметь цену на газ **выше**,
чем заданный лимит цены, или они не будут включены в блок.

Если для большинства нодов установлен определенный лимит цены, вводится правило, что транзакции в сети
не могут опускаться ниже определенного порога цены.

По умолчанию лимит цены имеет значение `0`, т. е. он не применяется принудительно.

Пример использования параметра `--price-limit`:
````bash
polygon-edge server --price-limit 100000 ...
````

Следует отметить, что лимиты цены **принудительно устанавливаются только для транзакций, не являющихся локальными**, т. е.
лимит цены не относится к транзакциям, которые добавляются на нод локально.
:::

:::info URL-адрес WebSocket
По умолчанию при запуске Polygon Edge генерируется WebSocket URL на базе расположения цепочки.
Схема URL `wss://` используется для ссылок HTTPS, а `ws://` — для HTTP.

URL-адрес Localhost WebSocket:
````bash
ws://localhost:10002/ws
````
Обратите внимание, что номер порта зависит от выбранного для нода порта JSON-RPC.

URL-адрес Edgenet WebSocket:
````bash
wss://rpc-edgenet.polygon.technology/ws
````
:::



## Шаг 5: взаимодействие с сетью Polygon Edge {#step-5-interact-with-the-polygon-edge-network}

Теперь мы настроили хотя бы 1 работающий клиент и можем начать взаимодействие с блокчейном, используя указанный выше предварительно пополненный аккаунт, и указать JSON-RPC URL для любого из 4 нодов:
- Нод 1: `http://localhost:10002`
- Нод 2: `http://localhost:20002`
- Нод 3: `http://localhost:30002`
- Нод 4: `http://localhost:40002`

Для отправки команд оператора на новый кластер следуйте указаниям этого руководства: [Как запрашивать информацию оператора](/docs/edge/working-with-node/query-operator-info) (порты GRPC построенного нами кластера `10000`/`20000`/`30000`/`40000` для каждого нода соответственно)
