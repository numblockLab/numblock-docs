---
id: pos-stake-unstake
title: Настройка и использование доказательства доли владения (PoS)
description: "Стейк, снятие стейка и другие инструкции, связанные со стейками."
keywords:
  - docs
  - polygon
  - edge
  - stake
  - unstake
  - validator
  - epoch
---

## Обзор {#overview}

В этом руководстве подробно рассказывается, как настроить сеть PoS в Polygon Edge и как делать стейки на ноды,
чтобы делать их валидаторами, и как отзывать средства из стейков.

Он **настоятельно рекомендуется** читать и пройти через  [Локальная настройка](/docs/edge/get-started/set-up-ibft-locally) / [Облачная настройка](/docs/edge/get-started/set-up-ibft-on-the-cloud), прежде чем продолжать использовать это руководство по PoS. В этих разделах описываются шаги, необходимые для запуска кластера доказательства полномочий (PoA) в
Polygon Edge.

В настоящее время отсутствует какой-либо лимит по количеству валидаторов, которые могут использовать средства для стейков смарт-контракта стейкинга.

## Смарт-контракт стейкинга {#staking-smart-contract}

Репозиторий смарт-контракта стейкинга находится [здесь](https://github.com/0xPolygon/staking-contracts).

В нем хранятся необходимые скрипты для тестирования, файлы ABI и сам смарт-контракт стейкинга.

## Настройка кластера нода N {#setting-up-an-n-node-cluster}

Настройка сети с помощью Polygon Edge описана в разделах
 [Локальная настройка](/docs/edge/get-started/set-up-ibft-locally) / [Облачная настройка](/docs/edge/get-started/set-up-ibft-on-the-cloud).

**Единственное отличие** между настройкой кластеров PoS и PoA заключается в генерировании генезиса.

**При генерировании файла генезиса для кластера PoS требуется дополнительный флаг `--pos`**:

```bash
polygon-edge genesis --pos ...
```

## Настройка длительности эпохи {#setting-the-length-of-an-epoch}

Эпохи подробно описываются в разделе [блоки эпохи](/docs/edge/consensus/pos-concepts#epoch-blocks).

Чтобы настроить размер эпохи для кластера (в блоках) при генерировании файла генезиса указывается дополнительный флаг
 `--epoch-size`:

```bash
polygon-edge genesis --epoch-size 50
```

Это значение в файле генезиса указывает, что размер эпохи должен составлять `50` блоков.

Значение размера эпохи по умолчанию (в блоках) составляет `100000`.

:::info Уменьшение длительности эпохи

Как описано в разделе [Блоки эпохи](/docs/edge/consensus/pos-concepts#epoch-blocks),
блоки эпохи используются для обновления наборов валидаторов для нодов.

Длина эпохи в блоках по умолчанию (`100000`) может быть слишком большой для обновления набора валидатора. Учитывая, что новые блоки добавляются примерно каждые 2 секунды, для возможного изменения набора валидаторов потребуется примерно 55,5 часа.

Если установить меньшее значение длины эпохи, набор валидаторов будет обновляться чаще.

:::

## Использование скриптов смарт-контракта стейкинга {#using-the-staking-smart-contract-scripts}

### Предварительные условия {#prerequisites}

Репозиторий смарт-контракта стейкинга — это проект Hardhat, требующий NPM.

Для правильной инициализации следует запустить в основном каталоге команду:

```bash
npm install
````

### Настройка предоставленных скриптов помощников {#setting-up-the-provided-helper-scripts}

Скрипты для взаимодействия с развернутым смарт-контрактом стейкинга находятся в [репозитории Staking Smart Contract](https://github.com/0xPolygon/staking-contracts).

Создайте файл `.env` со следующими параметрами в каталоге репозитория смарт-контрактов:

```bash
JSONRPC_URL=http://localhost:10002
PRIVATE_KEYS=0x0454f3ec51e7d6971fc345998bb2ba483a8d9d30d46ad890434e6f88ecb97544
STAKING_CONTRACT_ADDRESS=0x0000000000000000000000000000000000001001
BLS_PUBLIC_KEY=0xa..
```

Назначение параметров:

* **JSONRPC_URL** — конечная точка JSON-RPC для запуска нода
* **PRIVATE_KEYS** — приватные ключи адреса стейкера.
* **STAKING_CONTRACT_ADDRESS** — адрес смарт-контракта стейкинга (
по умолчанию `0x0000000000000000000000000000000000001001`)
* **BLS_PUBLIC_KEY** — публичный ключ BLS стейкера. Требуется, только если в сети используется BLS

### Средства для стейкинга {#staking-funds}

:::info Адрес стейкинга
Смарт-контракт стейкинга предварительно развернут по адресу `0x0000000000000000000000000000000000001001`.

Любое взаимодействие с механизмом стейкинга выполняется через смарт-контракт стейкинга по указанному адресу.

Больше о смарт-контракте стейкинга можно узнать в разделе
**[смарт-контракт](/docs/edge/consensus/pos-concepts#contract-pre-deployment)** .
:::

Чтобы стать частью набора валидаторов, адрес должен внести в качестве стейка определенную сумму средств сверх порогового значения.

В настоящее время пороговое значение по умолчанию для вхождения в набор валидаторов составляет `1 ETH`.

Стейкинг можно инициировать посредством вызова метода `stake` смарт-контракта стейкинга со значением `>= 1 ETH`.

После настройки файла `.env`, указанного в [предыдущем разделе](/docs/edge/consensus/pos-stake-unstake#setting-up-the-provided-helper-scripts), и запуска цепочки в режиме PoS стейкинг можно выполнить с помощью следующей команды в репозитории смарт-контракта стейкинга:

```bash
npm run stake
```

Скрипт `stake` Hardhat использует для стейка количество по умолчанию `1 ETH`, которое можно изменить посредством изменения файла `scripts/stake.ts`
.

Если используемые для стейка средства `>= 1 ETH`, набор валидаторов в смарт-контракте стейкинга обновляется и адрес
становится частью набора валидаторов начиная со следующей эпохи.

:::info Регистрация ключей BLS

Если сеть работает в режиме BLS, для получения статуса валидаторов ноды должны зарегистрировать публичные ключи BLS после стейкинга

Это можно сделать с помощью следующей команды:

```bash
npm run register-blskey
```
:::

### Отзыв средств из стейкинга {#unstaking-funds}

Адреса, у которых есть стейк, могут **отозвать из стейка только все средства** сразу.

После настройки файла `.env`, указанного в [предыдущем разделе](/docs/edge/consensus/pos-stake-unstake#setting-up-the-provided-helper-scripts),
и запуска цепочки в режиме PoS отзыв стейка можно выполнить с помощью следующей команды в репозитории Staking Smart Contract:

```bash
npm run unstake
```

### Доставка списка стейкеров {#fetching-the-list-of-stakers}

Все адреса, выделившие средства на стейк, сохраняются в смарт-контракте стейкинга.

После настройки файла `.env`, указанного в [предыдущем разделе](/docs/edge/consensus/pos-stake-unstake#setting-up-the-provided-helper-scripts),
и запуска цепочки в режиме PoS доставку режима валидаторов можно выполнить с помощью следующей команды в репозитории Staking Smart Contract:

```bash
npm run info
```
